
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Map test</title>
  </head>
  <body>
    <h1>Map test</h1>
    <div id="header1">Header</div>
    <div id="result1">Result</div>
    <p>
      Debug Console by Chrome : shift + Ctrl + I
    </p>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/3.14.0/js-yaml.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.10/lodash.min.js"></script>
    <script src="https://bundle.run/buffer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.0.0/mermaid.min.js"></script>
    <script type="module">

      import { MarkdownToYaml, GithubREST } from "https://haitusense.github.io/kanbantest/Pages/rest.js";
      
      const auth = null;
      const owner = 'haitusense'; 
      const repo = 'kanbantest'; 
      const report = 'Reports/'; 
      const lotname = 'Lot 20202H001'; 
      const githubREST = new GithubREST(auth);

      const Run = (async () => {

        //Search Issues
        console.log("Search Issues");

        let issues = await githubREST.asyncGetIssuesFromTitle(owner, repo, lotname);
        if(issues.length != 1){
          console.log("err");
          console.log(issues);
          return;
        }else{
          console.log("url : " + issues[0].html_url);
          
          //yaml from lot
          console.log("Travel Body");
          let body = await githubREST.asyncMergeIssueYaml(owner, repo, issues[0]);
          console.log(body);

        }

        //Search Issue and Map
        console.log("Search Issue");
        let issue = await githubREST.asyncGetIssueYamlFromTitle(owner, repo, lotname);

        //document.getElementById("result1").innerText = jsyaml.dump(k.Pre.State);
        document.getElementById("result1").innerHTML = '<a href="' + issue.url + '">' + lotname + '</a></br>';
        
        //let dst1 = await githubREST.asyncGetContent(owner, repo, report + issue.Pre.Report);
        let dst = await githubREST.asyncGetContentToYaml(owner, repo, report + issue.Pre.Report);      
        document.getElementById("result1").innerHTML += '<pre>' + jsyaml.dump(dst) + '</pre></br>';

        //Search Issue and Map
        document.getElementById("result1").innerHTML += '<pre>' + CreateMap(dst) + '</pre></br>';

        //Create Header
        document.getElementById("header1").innerHTML = '<pre>' + CreateGraph(dst) + '</pre></br>';

        mermaid.initialize({
          startOnLoad:true,
          theme: 'forest',
          flowchart:{
            useMaxWidth:false,
            htmlLabels:true
          }
        });
        window.mermaid.init(undefined, document.querySelectorAll('.language-mermaid'));
        
      })();
      
      function CreateGraph(src) {  
        var dst = '<code class="language-mermaid">'
        dst += "graph LR\r\n";
        dst += "A(Planed) --> B\r\n";
        dst += "B[Process-1] --> C\r\n";
        dst += "C[Process-2] --> E[Done]\r\n";
        dst += "style B fill:#f9f\r\n";
        dst += "</code>";
        return dst;
      }
 
      function CreateMap(src) {
        return 'Wf Map\r\n' 
          + '..' + src["1"].bin + src["2"].bin + '..' + '\r\n'
          + '.' + src["3"].bin + src["4"].bin + src["5"].bin + src["6"].bin + '.' + '\r\n'
          + '..' + src["7"].bin + src["8"].bin + '..' + '\r\n';
      }
    
    </script>
  </body>
</html>
