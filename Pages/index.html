<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>request test</title>
  </head>
  <body>
    <h1>Browser test</h1>
    <p>
      Test case for
      <a href="https://github.com/haitusense/kanbantest/issues/1"
        >issues#1</a
      >
    </p>
    <div id="area1">変更前</div>
    
    <script type='text/javascript' src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/3.14.0/js-yaml.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.10/lodash.min.js"></script>
    <script type="module">

      import { request } from "https://cdn.pika.dev/@octokit/request";
      import { Octokit } from "https://cdn.pika.dev/@octokit/rest";
      
      const octokit = new Octokit();
      const owner = 'haitusense'; 
      const repo = 'kanbantest'; 

      //myAsyncMethod();
      myGetIssueMethod();

      async function myAsyncMethod() {
        const result = await request({
          method: "GET",
        });
        console.log(result.data);
      }
    

      async function myGetIssueMethod() {
        
        const options = octokit.issues.listForRepo.endpoint.merge({ 
          owner: owner, 
          repo: repo 
        });
        octokit.paginate(options).then(issues => {
          issues.forEach(element => {
            console.log("title : " + element.title);
            //console.log(element);
            var k = MergeIssueYaml(element);
            if(k != null){
              console.log(k);
              document.getElementById("area1").innerText = jsyaml.dump(k.Pre.State);
            }
          });
        })
      }

      function MergeIssueYaml(element){
        let issuebody = element.body;
        let issuenum = element.number;

        var yaml = MarkdownToYaml(issuebody);
        if(yaml == null) return null;

        octokit.issues.listComments({
          owner: owner, 
          repo: repo,
          issue_number : issuenum
        }).then(comments => {
          comments.data.forEach(element => {
            var yaml2 = MarkdownToYaml(element.body);
            if(yaml2 != null){
              _.merge(yaml, yaml2)
            }
          });
        });

        return yaml;
      }
      
      function MarkdownToYaml(body){
        const regExp = /```([^)]+)```/gm;
        var matches = regExp.exec(body);
        if(matches == null) return null;
        return jsyaml.load(matches[1]);
      }

    </script>
  </body>
</html>
